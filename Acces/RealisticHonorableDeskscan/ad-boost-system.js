/**
 * Ad Boost System - Client Side
 * Handles rewarded ad display and boost activation
 */

(function() {
  'use strict';

  // Google Publisher Tag setup
  window.googletag = window.googletag || { cmd: [] };

  let rewardedSlot = null;
  let rewardGranted = false;
  let currentUserId = null;

  /**
   * Initialize rewarded ad slot
   * Can be called multiple times to reinitialize after ad is closed
   */
  function initializeRewardedAd() {
    console.log('ğŸ”„ Initializing rewarded ad slot...');

    googletag.cmd.push(() => {
      // Get ad unit ID from environment (will be set via server)
      const adUnitId = window.REWARDED_AD_UNIT_ID || '/22639388115/rewarded_web_example';

      // Clear existing slot if any
      if (rewardedSlot) {
        googletag.destroySlots([rewardedSlot]);
        rewardedSlot = null;
      }

      rewardedSlot = googletag.defineOutOfPageSlot(
        adUnitId,
        googletag.enums.OutOfPageFormat.REWARDED
      );

      if (rewardedSlot) {
        rewardedSlot.addService(googletag.pubads());

        // Ad is ready to be shown
        googletag.pubads().addEventListener('rewardedSlotReady', (event) => {
          console.log('âœ… Rewarded ad is ready');

          // Show the ad when user clicks "Watch Ad" button
          const watchButton = document.getElementById('watch-ad-button');
          if (watchButton) {
            watchButton.onclick = () => {
              event.makeRewardedVisible();
              closeAdBoostModal();
              console.log('ğŸ“º Showing rewarded ad');
            };
          }
        });

        // Ad video has finished playing
        googletag.pubads().addEventListener('rewardedSlotVideoCompleted', (event) => {
          console.log('âœ… Ad video completed');
        });

        // Ad was closed (with or without reward)
        googletag.pubads().addEventListener('rewardedSlotClosed', handleAdClosed);

        // Reward was granted (ad watched fully)
        googletag.pubads().addEventListener('rewardedSlotGranted', (event) => {
          rewardGranted = true;
          console.log('ğŸ Reward granted! Payload:', event.payload);
        });

        // No ad available
        googletag.pubads().addEventListener('slotRenderEnded', (event) => {
          if (event.slot === rewardedSlot && event.isEmpty) {
            console.warn('âš ï¸ No ad returned for rewarded ad slot');
            showMessage('No ad available right now. Please try again later.', 'warning');
          }
        });

        googletag.enableServices();
        googletag.display(rewardedSlot);

        console.log('âœ… Rewarded ad slot initialized successfully');
      } else {
        console.error('âŒ Rewarded ads are not supported on this page');
      }
    });
  }

  // Initialize on page load
  initializeRewardedAd();

  /**
   * Handle ad closed event
   * SERVER-AUTHORITATIVE: Only grant if ad completed fully
   */
  async function handleAdClosed() {
    console.log('ğŸ“º Ad closed. Reward granted:', rewardGranted);

    // STRICT: If ad not completed, allow retry
    if (!rewardGranted) {
      console.warn('âš ï¸ Ad was closed before completion - NO reward granted');
      showMessage('Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ù… ÙŠÙƒØªÙ…Ù„. Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙƒØ§Ù…Ù„Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©.', 'warning');
      
      // Cleanup and allow retry
      if (rewardedSlot) {
        googletag.destroySlots([rewardedSlot]);
        rewardedSlot = null;
      }
      
      setTimeout(() => {
        initializeRewardedAd();
      }, 500);
      
      return; // EXIT - no reward
    }

    // âœ… Ad completed - grant reward SERVER-SIDE ONLY
    if (currentUserId) {
      try {
        const transactionId = `ad_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const response = await fetch('/api/ad-boost/grant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: currentUserId,
            transactionId: transactionId,
            adCompleted: true
          })
        });

        const result = await response.json();

        if (result.success) {
          console.log('âœ… Server granted boost:', result);

          // Show success message - gradual accumulation like referrals
          showMessage(`âœ… ØªÙ…! ØªØ¹Ø²ÙŠØ² +1.2 MH/s Ù†Ø´Ø· - Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ØªØªØ±Ø§ÙƒÙ… ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§ Ø®Ù„Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ†`, 'success');

          // Update hashrate display
          if (result.boostActive) {
            updateHashrateDisplay(1.2);
          }

          // No instant balance refresh needed - reward accumulates gradually

          rewardGranted = false;
          
        } else {
          console.error('âŒ Server rejected:', result.error);
          showMessage(`âŒ ${result.error}`, 'error');
        }

      } catch (error) {
        console.error('âŒ Error:', error);
        showMessage('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
      }
    }

    // Cleanup
    if (rewardedSlot) {
      googletag.destroySlots([rewardedSlot]);
      rewardedSlot = null;
    }

    setTimeout(() => {
      initializeRewardedAd();
    }, 500);
  }

  /**
   * Show ad boost modal when user clicks on XP/s
   */
  async function showAdBoostModal(userId) {
    currentUserId = userId;

    console.log('showAdBoostModal called for user:', userId);

    try {
      // Check eligibility Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
      console.log('Checking eligibility at: /api/ad-boost/check?userId=' + userId);
      const response = await fetch(`/api/ad-boost/check?userId=${userId}`);
      const result = await response.json();

      console.log('Eligibility check result:', result);

      if (!result.success) {
        console.error('Eligibility check failed:', result);
        showMessage(translator.translate('Failed to check eligibility'), 'error');
        return;
      }

      // Show modal ÙÙˆØ±Ø§Ù‹
      const modal = document.getElementById('ad-boost-modal');
      if (!modal) {
        console.error('âŒ ad-boost-modal element not found in DOM!');
        showMessage(translator.translate('Ad system not ready. Please refresh the page.'), 'error');
        return;
      }

      modal.style.display = 'block';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';

      if (!result.eligible) {
        console.log('User not eligible:', result.reason);

        // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
        const watchButton = document.getElementById('watch-ad-button');
        if (watchButton) {
          watchButton.style.display = 'none';
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ØµØ­ÙŠØ­
        if (result.reason === 'already_boosted_this_session') {
          showCooldownMessage(result.remainingSeconds || 0, result.reason);
        } else if (result.reason === 'not_mining') {
          showCooldownMessage(0, 'not_mining');
        } else if (result.reason === 'cooldown') {
          showCooldownMessage(result.remainingSeconds, 'cooldown');
        } else {
          showMessage(translator.translate(result.message || result.reason || 'Not eligible for ad boost'), 'warning');
        }
      } else {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‡Ù„ - Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
        const watchButton = document.getElementById('watch-ad-button');
        const cooldownDiv = document.getElementById('ad-cooldown-message');

        if (watchButton) {
          watchButton.style.display = 'block';
        }
        if (cooldownDiv) {
          cooldownDiv.style.display = 'none';
        }

        console.log('âœ… Modal ready - User can watch ad');
      }

    } catch (error) {
      console.error('Error checking ad boost eligibility:', error);
      showMessage(translator.translate('Failed to check eligibility') + ': ' + error.message, 'error');
    }
  }

  /**
   * Close ad boost modal
   */
  function closeAdBoostModal() {
    const modal = document.getElementById('ad-boost-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  /**
   * Close ad boost modal when clicking outside of it
   */
  window.closeAdBoostModalOnOutsideClick = function(event) {
    const modal = document.getElementById('ad-boost-modal');
    if (event.target === modal) {
      closeAdBoostModal();
    }
  }

  /**
   * Show cooldown/restriction message
   */
  function showCooldownMessage(remainingSeconds, reason) {
    const modal = document.getElementById('ad-boost-modal');
    const cooldownDiv = document.getElementById('ad-cooldown-message');
    const messageContainer = document.getElementById('cooldown-message-container');
    const timeDisplay = document.getElementById('cooldown-time-display');

    if (modal && cooldownDiv && messageContainer && timeDisplay) {
      let messageText = '';
      let timeText = '';

      // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† remainingSeconds Ø±Ù‚Ù… ØµØ­ÙŠØ­
      const validSeconds = Math.max(0, Math.floor(remainingSeconds || 0));

      if (reason === 'already_boosted_this_session' || reason === 'not_mining') {
        // Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const hours = Math.floor(validSeconds / 3600);
        const minutes = Math.floor((validSeconds % 3600) / 60);

        messageText = document.getElementById('ad-boost-cooldown-message')?.textContent || 'Ad boost active! Wait for session to end';

        // Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙˆÙ‚Øª Ù…ØªØ¨Ù‚ÙŠ
        if (validSeconds > 0) {
          timeText = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m`;
        } else {
          timeText = '00h 00m';
        }
      } else if (reason === 'boost_pending') {
        messageText = 'Ad boost granted! Start mining to activate it.';
        timeText = '';
      } else {
        const hours = Math.floor(validSeconds / 3600);
        const minutes = Math.floor((validSeconds % 3600) / 60);

        messageText = document.getElementById('ad-boost-wait-message')?.textContent || 'Wait to watch another ad';
        timeText = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m`;
      }

      messageContainer.textContent = messageText;
      timeDisplay.textContent = timeText;
      timeDisplay.style.display = timeText ? 'block' : 'none';
      cooldownDiv.style.display = 'block';

      // Hide "Watch Ad" button
      const watchButton = document.getElementById('watch-ad-button');
      if (watchButton) {
        watchButton.style.display = 'none';
      }

      console.log(`Cooldown message: ${messageText} - Time: ${timeText} (${validSeconds}s)`);
    }
  }

  /**
   * Update hashrate display with boost
   * SERVER-SIDE STATE ONLY - No localStorage persistence
   */
  function updateHashrateDisplay(boostValue) {
    // NO localStorage - rely on server state only
    
    // Update Dashboard hashrate
    const hashrateValue = document.getElementById('dashboard-hashrate-value');
    if (hashrateValue) {
      const adBoostIncluded = hashrateValue.getAttribute('data-ad-boost-active') === 'true';

      if (!adBoostIncluded) {
        const baseHashrate = 10.0;
        const currentValue = parseFloat(hashrateValue.textContent) || baseHashrate;
        const newValue = currentValue + boostValue;

        hashrateValue.textContent = newValue.toFixed(1);
        hashrateValue.setAttribute('data-ad-boost-active', 'true');
        hashrateValue.setAttribute('data-ad-boost-value', boostValue);
        hashrateValue.style.color = '#4ade80';

        console.log(`âœ… Dashboard Ad Boost applied: ${currentValue.toFixed(1)} â†’ ${newValue.toFixed(1)} MH/s`);
      }
    }

    // Update Activity page hashrate
    const activityHashrateValue = document.getElementById('hashrate-value');
    const activityHashrateDisplay = document.getElementById('hashrate-display');
    if (activityHashrateValue && activityHashrateDisplay) {
      const adBoostIncluded = activityHashrateValue.getAttribute('data-ad-boost-active') === 'true';

      if (!adBoostIncluded) {
        const baseHashrate = 10.0;
        const currentActivityValue = parseFloat(activityHashrateValue.textContent) || baseHashrate;
        const newActivityValue = currentActivityValue + boostValue;

        activityHashrateValue.textContent = newActivityValue.toFixed(1);
        activityHashrateValue.setAttribute('data-ad-boost-active', 'true');
        activityHashrateValue.setAttribute('data-ad-boost-value', boostValue);
        activityHashrateValue.style.color = '#4ade80';

        activityHashrateDisplay.style.display = 'flex';
        activityHashrateDisplay.style.visibility = 'visible';
        activityHashrateDisplay.style.opacity = '1';

        console.log(`âœ… Activity Ad Boost applied: ${currentActivityValue.toFixed(1)} â†’ ${newActivityValue.toFixed(1)} MH/s`);
      }
    }
  }

  /**
   * Reset hashrate display to base value (without ad boost)
   * Server-side triggered reset
   */
  function resetHashrateDisplay() {
    console.log('ğŸ”„ Resetting hashrate display - server-side state');

    // Reset Dashboard hashrate to base value
    const hashrateValue = document.getElementById('dashboard-hashrate-value');
    if (hashrateValue && hashrateValue.getAttribute('data-ad-boost-active') === 'true') {
      const adBoostValue = parseFloat(hashrateValue.getAttribute('data-ad-boost-value')) || 1.2;
      const currentValue = parseFloat(hashrateValue.textContent) || 10.0;
      const baseValue = currentValue - adBoostValue;

      hashrateValue.textContent = baseValue.toFixed(1);
      hashrateValue.removeAttribute('data-ad-boost-active');
      hashrateValue.removeAttribute('data-ad-boost-value');
      hashrateValue.style.color = '';

      console.log(`âœ… Dashboard hashrate reset: ${currentValue.toFixed(1)} â†’ ${baseValue.toFixed(1)} MH/s`);
    }

    // Reset Activity page hashrate
    const activityHashrateValue = document.getElementById('hashrate-value');
    if (activityHashrateValue && activityHashrateValue.getAttribute('data-ad-boost-active') === 'true') {
      const adBoostValue = parseFloat(activityHashrateValue.getAttribute('data-ad-boost-value')) || 1.2;
      const currentValue = parseFloat(activityHashrateValue.textContent) || 10.0;
      const baseValue = currentValue - adBoostValue;

      activityHashrateValue.textContent = baseValue.toFixed(1);
      activityHashrateValue.removeAttribute('data-ad-boost-active');
      activityHashrateValue.removeAttribute('data-ad-boost-value');
      activityHashrateValue.style.color = '';

      console.log(`âœ… Activity hashrate reset: ${currentValue.toFixed(1)} â†’ ${baseValue.toFixed(1)} MH/s`);
    }

    console.log('âœ… Hashrate display reset complete');
  }

  /**
   * Show message to user
   */
  function showMessage(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);

    // You can integrate with existing toast/notification system here
    if (typeof window.showToast === 'function') {
      window.showToast(message, type);
    }
  }

  /**
   * Make XP/s clickable on dashboard
   */
  function initializeAdBoostUI() {
    const hashrateDisplay = document.getElementById('dashboard-hashrate-display');

    if (hashrateDisplay) {
      // Make it clickable
      hashrateDisplay.style.cursor = 'pointer';
      hashrateDisplay.title = 'Click to boost your XP/s with an ad!';

      // Remove any existing listeners
      const newHashrateDisplay = hashrateDisplay.cloneNode(true);
      hashrateDisplay.parentNode.replaceChild(newHashrateDisplay, hashrateDisplay);

      newHashrateDisplay.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        console.log('XP/s clicked - checking user...');

        // Try multiple ways to get user ID
        let userId = null;

        // Method 1: window.currentUser
        if (window.currentUser && window.currentUser.id) {
          userId = window.currentUser.id;
          console.log('Found user from window.currentUser:', userId);
        }

        // Method 2: localStorage
        if (!userId) {
          try {
            const savedUser = localStorage.getItem('accessoireUser');
            if (savedUser) {
              const userData = JSON.parse(savedUser);
              userId = userData.id;
              console.log('Found user from localStorage:', userId);
            }
          } catch (e) {
            console.warn('Could not parse localStorage user data');
          }
        }

        if (userId) {
          console.log('Showing ad boost modal for user:', userId);
          showAdBoostModal(userId);
        } else {
          console.error('No user logged in');
          showMessage('Please log in to use ad boost', 'warning');
        }
      });

      // Add visual indicator
      newHashrateDisplay.classList.add('ad-boost-enabled');

      console.log('âœ… Ad boost UI initialized on dashboard-hashrate-display');
    } else {
      console.warn('âš ï¸ dashboard-hashrate-display not found');
    }

    // Close modal button
    const closeButton = document.getElementById('close-ad-modal-button');
    if (closeButton) {
      closeButton.addEventListener('click', closeAdBoostModal);
    }

    // Check boost status on page load
    checkBoostStatus();
  }

  /**
   * Check current boost status
   */
  async function checkBoostStatus() {
    const userId = window.currentUser?.id;
    if (!userId) return;

    try {
      const response = await fetch(`/api/ad-boost/status?userId=${userId}`);
      const result = await response.json();

      if (result.success && result.exists) {
        if (result.boostActive) {
          console.log('âœ… Ad boost is currently active');
          // Visual indicator could be added here
        } else if (result.boostGranted) {
          console.log('â³ Ad boost granted but not active yet (start mining to activate)');
        }
      }
    } catch (error) {
      console.error('Error checking boost status:', error);
    }
  }

  // Verify modal exists in DOM
  function verifyModalExists() {
    const modal = document.getElementById('ad-boost-modal');
    if (!modal) {
      console.error('âŒ CRITICAL: ad-boost-modal not found in index.html!');
      console.log('Please ensure the modal HTML is present in index.html');
      return false;
    }
    console.log('âœ… ad-boost-modal verified in DOM');
    return true;
  }

  /**
   * Check server state for ad boost on page load
   * NO localStorage - pure server-side state
   */
  async function checkAdBoostOnLoad() {
    if (!window.currentUser || !window.currentUser.id) return;

    try {
      const response = await fetch(`/api/ad-boost/status?userId=${window.currentUser.id}`);
      const data = await response.json();

      if (data.success && data.boostActive) {
        console.log('âœ… Server confirms ad boost is active');
        updateHashrateDisplay(1.2);
      } else {
        console.log('â­• Server confirms no active ad boost');
        resetHashrateDisplay();
      }
    } catch (error) {
      console.error('Error checking ad boost status:', error);
    }
  }

  // Check server state on page load
  window.addEventListener('load', () => {
    setTimeout(checkAdBoostOnLoad, 1000);
  });

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        verifyModalExists();
        initializeAdBoostUI();
      }, 500);
    });
  } else {
    setTimeout(() => {
      verifyModalExists();
      initializeAdBoostUI();
    }, 500);
  }

  // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø²ÙŠØ² Ù…Ù† ØµÙØ­Ø© Activity
  window.showActivityBoost = function() {
    console.log('Activity Boost button clicked');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let userId = null;

    if (window.currentUser && window.currentUser.id) {
      userId = window.currentUser.id;
    } else {
      try {
        const savedUser = localStorage.getItem('accessoireUser');
        if (savedUser) {
          const userData = JSON.parse(savedUser);
          userId = userData.id;
        }
      } catch (e) {
        console.warn('Could not parse localStorage user data');
      }
    }

    if (userId) {
      console.log('Opening ad boost modal from Activity page for user:', userId);
      showAdBoostModal(userId);
    } else {
      console.error('No user logged in');
      showMessage('Please log in to use ad boost', 'warning');
    }
  };

  // Export functions for use elsewhere
  window.AdBoostSystem = {
    showModal: showAdBoostModal,
    closeModal: closeAdBoostModal,
    checkStatus: checkBoostStatus,
    verify: verifyModalExists,
    showFromActivity: window.showActivityBoost,
    resetDisplay: resetHashrateDisplay  // NEW: Reset hashrate without losing balance
  };

  console.log('âœ… Ad Boost System loaded');

})();